{"version":3,"file":"lib.js","sources":["../src/utils/index.ts","../src/DBSClient.ts"],"sourcesContent":["import { ethers, Signer, sha256, toUtf8Bytes } from 'ethers'\n\n/**\n * @param {string} quoteId - The quote ID.\n * @param {Signer} signer The signer object.\n * @param {number} nonce - A timestamp (must be higher than the previously stored nonce for the user).\n * @returns {Promise<string>} - A promise that resolves to the signed hash.\n */\nexport const getSignedHash = async (signer: Signer, quoteId: string, nonce: number) => {\n  // Create a hash\n  const hash = sha256(toUtf8Bytes(quoteId + nonce.toString()))\n\n  // Sign the hash\n  const signedHash = await signer.signMessage(ethers.getBytes(hash))\n\n  return signedHash\n}\n","import { ethers, Signer } from 'ethers'\nimport axios from 'axios'\nimport FormData from 'form-data'\nimport {\n  StorageInfo,\n  GetQuoteArgs,\n  GetQuoteResult,\n  GetStatusResult,\n  GetLinkResult,\n  RegisterArgs,\n  File\n} from './@types'\nimport { getSignedHash } from './utils'\n\n/**\n * DBSClient is a TypeScript library for interacting with the DBS API.\n */\nexport class DBSClient {\n  private baseURL: string\n  private signer: Signer\n\n  /**\n   * Creates an instance of the DBSClient.\n   * @param {string} baseURL - The base URL of the DBS API.\n   * @param {Signer} signer The signer object.\n   */\n  constructor(baseURL: string, signer?: Signer) {\n    this.baseURL = baseURL\n    this.signer = signer\n  }\n\n  /**\n   * Fetches information about supported storage types and payments.\n   *\n   * @returns {Promise<StorageInfo[]>} - A promise that resolves to an array of storage information.\n   */\n  async getStorageInfo(): Promise<StorageInfo[]> {\n    const response = await axios.get<StorageInfo[]>(`${this.baseURL}/`)\n    return response.data\n  }\n\n  /**\n   * Fetches a quote for storing files on a specific storage.\n   *\n   * @param {GetQuoteArgs} args - The arguments needed for getting a quote.\n   * @returns {Promise<GetQuoteResult>} - A promise that resolves to the quote result.\n   */\n  async getQuote(args: GetQuoteArgs): Promise<GetQuoteResult> {\n    const response = await axios.post<GetQuoteResult>(`${this.baseURL}/getQuote`, args)\n    return response.data\n  }\n\n  /**\n   * Uploads files according to the quote request.\n   *\n   * @param {string} quoteId - The quote ID.\n   * @param {File[]} files - An array of files to upload.\n   * @returns {Promise<void>}\n   */\n  async upload(quoteId: string, files: File[]): Promise<void> {\n    const nonce = Date.now()\n    const signature = await getSignedHash(this.signer, quoteId, nonce)\n    const formData = new FormData()\n    files.forEach((file, index) => {\n      formData.append(`file${index}`, new Blob([new ArrayBuffer(file.length)]))\n    })\n\n    await axios.post(`${this.baseURL}/upload`, formData, {\n      params: { quoteId, nonce, signature },\n      headers: { 'Content-Type': 'multipart/form-data' }\n    })\n  }\n\n  /**\n   * Fetches a quote for storing files on a specific storage and uploads files according to the quote request.\n   * @param {GetQuoteArgs} args - The arguments needed for getting a quote.\n   * @returns {Promise<GetQuoteResult>}\n   */\n  async getQuoteAndUpload(args: GetQuoteArgs): Promise<GetQuoteResult> {\n    const quote = await this.getQuote(args)\n    await this.upload(quote.quoteId, args.files)\n    return quote\n  }\n\n  /**\n   * Fetches the status of a job.\n   *\n   * @param {string} quoteId - The quote ID.\n   * @returns {Promise<GetStatusResult>} - A promise that resolves to the status result.\n   */\n  async getStatus(quoteId: string): Promise<GetStatusResult> {\n    const response = await axios.post<GetStatusResult>(`${this.baseURL}/getStatus`, {\n      quoteId\n    })\n    return response.data\n  }\n\n  /**\n   * Fetches the DDO files object for a job.\n   *\n   * @param {string} quoteId - The quote ID.\n   * @returns {Promise<GetLinkResult[]>} - A promise that resolves to an array of link results.\n   */\n\n  async getLink(quoteId: string): Promise<GetLinkResult[]> {\n    const nonce = Date.now()\n    const signature = await getSignedHash(this.signer, quoteId, nonce)\n    const response = await axios.post<GetLinkResult[]>(`${this.baseURL}/getLink`, null, {\n      params: { quoteId, nonce, signature }\n    })\n    return response.data\n  }\n\n  /**\n   * Registers a new microservice that handles a storage type.\n   *\n   * @param {RegisterArgs} args - The arguments needed for registering a microservice.\n   * @returns {Promise<void>}\n   */\n  async registerMicroservice(args: RegisterArgs): Promise<void> {\n    await axios.post(`${this.baseURL}/register`, args)\n  }\n}\n"],"names":["getSignedHash","signer","quoteId","nonce","hash","sha256","toUtf8Bytes","toString","Promise","resolve","signMessage","ethers","getBytes","e","reject","DBSClient","baseURL","this","_proto","prototype","getStorageInfo","axios","get","then","response","data","getQuote","args","post","upload","files","_this3","Date","now","signature","formData","FormData","forEach","file","index","append","Blob","ArrayBuffer","length","params","headers","getQuoteAndUpload","_this4","quote","getStatus","getLink","_this6","registerMicroservice"],"mappings":"sLAQaA,WAAuBC,EAAgBC,EAAiBC,OAEnE,IAAMC,EAAOC,EAAMA,OAACC,EAAWA,YAACJ,EAAUC,EAAMI,aAAY,OAAAC,QAAAC,QAGnCR,EAAOS,YAAYC,EAAMA,OAACC,SAASR,IAG9D,CAAC,MAAAS,GAAAL,OAAAA,QAAAM,OAAAD,EAAA,CAAA,iCCCqB,WASpB,SAAAE,EAAYC,EAAiBf,GARrBe,KAAAA,oBACAf,YAAM,EAQZgB,KAAKD,QAAUA,EACfC,KAAKhB,OAASA,CAChB,CAAC,IAAAiB,EAAAH,EAAAI,iBAAAD,EAOKE,eAAcA,WAAA,IACqC,OAAAZ,QAAAC,QAAhCY,UAAMC,IAAsBL,KAAKD,QAAU,MAACO,KAA7DC,SAAAA,GACN,OAAOA,EAASC,IAAI,EACtB,CAAC,MAAAZ,GAAAL,OAAAA,QAAAM,OAAAD,KAAAK,EAQKQ,SAAQ,SAACC,GAAkB,IAC0B,OAAAnB,QAAAC,QAAlCY,UAAMO,KAAwBX,KAAKD,QAAoBW,YAAAA,IAAKJ,KAAA,SAA7EC,GACN,OAAOA,EAASC,IAAI,EACtB,CAAC,MAAAZ,GAAAL,OAAAA,QAAAM,OAAAD,EAAAK,CAAAA,EAAAA,EASKW,OAAMA,SAAC3B,EAAiB4B,GAAa,IAAAC,IAAAA,EAEHd,KADhCd,EAAQ6B,KAAKC,MAAK,OAAAzB,QAAAC,QACAT,EAAc+B,EAAK9B,OAAQC,EAASC,IAAMoB,KAAA,SAA5DW,GACN,IAAMC,EAAW,IAAIC,EAAAA,QAGnB,OAFFN,EAAMO,QAAQ,SAACC,EAAMC,GACnBJ,EAASK,OAAcD,OAAAA,EAAS,IAAIE,KAAK,CAAC,IAAIC,YAAYJ,EAAKK,UACjE,GAAEnC,QAAAC,QAEIY,UAAMO,KAAQG,EAAKf,QAAO,UAAWmB,EAAU,CACnDS,OAAQ,CAAE1C,QAAAA,EAASC,MAAAA,EAAO+B,UAAAA,GAC1BW,QAAS,CAAE,eAAgB,0BAC3BtB,KACJ,WAAA,EAAA,EAAA,CAAC,MAAAV,GAAAL,OAAAA,QAAAM,OAAAD,EAAAK,CAAAA,EAAAA,EAOK4B,kBAAiBA,SAACnB,GAAkB,IAAAoB,IAAAA,EACpB9B,YAAIT,QAAAC,QAAJsC,EAAKrB,SAASC,IAAKJ,KAAjCyB,SAAAA,GAAKxC,OAAAA,QAAAC,QACLsC,EAAKlB,OAAOmB,EAAM9C,QAASyB,EAAKG,QAAMP,KAC5C,WAAA,OAAOyB,CAAK,EACd,EAAA,CAAC,MAAAnC,GAAAL,OAAAA,QAAAM,OAAAD,EAAAK,CAAAA,EAAAA,EAQK+B,UAASA,SAAC/C,GAAe,IAC6BM,OAAAA,QAAAC,QAAnCY,EAAAA,QAAMO,KAAyBX,KAAKD,QAAO,aAAc,CAC9Ed,QAAAA,KACAqB,KAFIC,SAAAA,GAGN,OAAOA,EAASC,IAAI,EACtB,CAAC,MAAAZ,GAAA,OAAAL,QAAAM,OAAAD,EAAA,CAAA,EAAAK,EASKgC,QAAOA,SAAChD,GAAe,IAAAiD,IAAAA,EAEWlC,KADhCd,EAAQ6B,KAAKC,MAAK,OAAAzB,QAAAC,QACAT,EAAcmD,EAAKlD,OAAQC,EAASC,IAAMoB,KAAA,SAA5DW,GAAS,OAAA1B,QAAAC,QACQY,EAAAA,QAAMO,KAAyBuB,EAAKnC,QAAO,WAAY,KAAM,CAClF4B,OAAQ,CAAE1C,QAAAA,EAASC,MAAAA,EAAO+B,UAAAA,MAC1BX,KAAA,SAFIC,GAGN,OAAOA,EAASC,IAAI,EAAA,EACtB,CAAC,MAAAZ,GAAA,OAAAL,QAAAM,OAAAD,EAAA,CAAA,EAAAK,EAQKkC,qBAAoB,SAACzB,GAAkB,IACnBnB,OAAAA,QAAAC,QAAlBY,EAAK,QAACO,KAAQX,KAAKD,QAAO,YAAaW,IAAKJ,KACpD,WAAA,EAAA,CAAC,MAAAV,GAAAL,OAAAA,QAAAM,OAAAD,KAAAE,CAAA,CAxGmB"}